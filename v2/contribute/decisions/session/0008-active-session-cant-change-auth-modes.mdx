---
id: "0008"
title: Active session can't change auth-modes
hide_title: true
---

import DecisionHeader from "/src/components/decisionLogs/DecisionHeader"
import ArgumentPro from "/src/components/decisionLogs/ArgumentPro"
import ArgumentCon from "/src/components/decisionLogs/ArgumentCon"
import ArgumentNeut from "/src/components/decisionLogs/ArgumentNeut"

# Active session can't change auth-modes (except legacy sessions)

<DecisionHeader status="proposed" lastUpdate="2022-11-22" created="2022-10-25" deciders={["rishabhpoddar", "porcellus"]} proposedBy={["porcellus"]} />

## Context and Problem Statement

We need to decide if we can upgrade in get/verifySession on refresh calls

## Considered Options

* All
* Refresh only
* None (change in settings only take effect when creating new session)

## Decision Outcome

Active session can't change auth-modes (except legacy sessions). Reasons:
- Allowing it in all request would increase implementation complexity for not much gain and it'd make our vulnerability of XSS attacks worse.
- If we allow changing the auth-mode during session refresh we increase the attack surface of XSS.
- An XSS attack could still steal tokens by changing the auth-method during sign-in, but in this case they could also capture the user credentials.
- This means that changing the default auth-mode in the frontend SDK will only have effect after the user logs in again.

As a consequence:
- Refresh session will not change the auth-mode of incoming requests.
- In case both cookies and headers are there, we default to headers (see [here](./0003-default-to-header-based-auth-if-not-specified-by-FE))
- Respecting the auth-mode header in case both exist would serve no purpose:
    - we are clearing token transfer methods we are not using when creating and refreshing session, so this should not happen when using a FE SDK
    - there can be some edge cases (changing versions back-and-forth during development): we are not optimising for this
    - it could be an attacker manipulating through XSS: they could just as easily change the auth-mode header as well (besides calling logout to clear old cookies before adding their own tokens)
    - the most likely case is someone sending manual requests: headers should take priority as that's more likely to be intentional.
    - if the backend overrides `getTokenTransferMethod` to only allow one transfer method we do no harm by allowing the refresh since it will fail the session verification anyway
        - This could mean an infinite refresh loop if the configurations don't match and it's not an attacker trying to access something.
        - If we throw UNAUTHORISED in this case we 
- In case both cookies and headers are there, refresh will clear the one we are not using.

### Expected behaviour of refreshSession as a table

| Authorization header 	| Refresh token cookie 	| Output                    	            | Set tokens in  | Cleared tokens        |
|----------------------	|---------------------	|-----------------------------------------	|--------------  |-------------------	 |
| none                 	| none               	| UNAUTHORISED              	            | -              | none                  |
| none                 	| exists               	| Validate refresh token from cookie        | cookies        | none                  |
| exists               	| none                 	| Validate refresh token from header        | headers        | none                  |
| exists               	| exists               	| Validate refresh token from header        | headers        | cookies               |
