---
sidebar_position: 1
title: Managing roles and sessions
hide_title: true
---

<!-- COPY DOCS -->
<!-- ./userroles/managing-roles-and-sessions.mdx -->

import BackendSDKTabs from "/src/components/tabs/BackendSDKTabs"
import NodeJSFrameworkSubTabs from "/src/components/tabs/NodeJSFrameworkSubTabs";
import PythonFrameworkSubTabs from "/src/components/tabs/PythonFrameworkSubTabs";
import TabItem from '@theme/TabItem';

# Managing roles and sessions

After you create a role and assign it to as user, you can add the role information to their session. You can then use this information to read and verify the role and permissions in your API and website routes

## Adding roles to a session

We can set the user's role in the access token by overriding the `createNewSession` function in the `init` function:

<BackendSDKTabs>
<TabItem value="nodejs">

```tsx
import SuperTokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserRoles from "supertokens-node/recipe/userroles";

SuperTokens.init({
    supertokens: {
        connectionURI: "...",
    },
    appInfo: {
        apiDomain: "...",
        appName: "...",
        websiteDomain: "..."
    },
    recipeList: [
        Session.init({
            // highlight-start
            override: {
                functions: (originalImplementation) => {
                    return {
                        ...originalImplementation,
                        createNewSession: async function (input) {
                            let userId = input.userId;

                            let roles = await UserRoles.getRolesForUser(userId);

                            input.accessTokenPayload = {
                                ...input.accessTokenPayload,
                                roles
                            };

                            return originalImplementation.createNewSession(input);
                        },
                    };
                },
            },
            // highlight-end
        })
    ]
});
```
</TabItem>
<TabItem value="go">

TODO
</TabItem>
<TabItem value="python">

TODO
</TabItem>
</BackendSDKTabs>

You can also set the permissions to their session directly by fetching the list of permissions assigned to a role (refer to the [Managing Roles and Permissions Page](./managing-roles-and-permissions))

## Updating roles in a session

Post session verification, you can use the `updateAccessTokenPayload` function to update the user's role:

<BackendSDKTabs>
<TabItem value="nodejs">
<NodeJSFrameworkSubTabs>
<TabItem value="express">

```tsx
import { verifySession } from "supertokens-node/recipe/session/framework/express";
import express from "express";
import { SessionRequest } from "supertokens-node/framework/express";
import UserRoles from "supertokens-node/recipe/userroles";

let app = express();

app.post("/set-role", verifySession(), async (req: SessionRequest, res) => {

    let userId = req.session!.getUserId();

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
        return;
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    let currAccessTokenPayload = req.session!.getAccessTokenPayload();

    await req.session!.updateAccessTokenPayload(
        { ...currAccessTokenPayload, roles }
    );
    // highlight-end

    //....
});
```
</TabItem>
<TabItem value="hapi">

```tsx
import Hapi from "@hapi/hapi";
import { verifySession } from "supertokens-node/recipe/session/framework/hapi";
import {SessionRequest} from "supertokens-node/framework/hapi";
import UserRoles from "supertokens-node/recipe/userroles";

let server = Hapi.server({ port: 8000 });

server.route({
    path: "/set-role",
    method: "post",
    options: {
        pre: [
            {
                method: verifySession()
            },
        ],
    },
    handler: async (req: SessionRequest, res) => {
        let userId = req.session!.getUserId();

        // highlight-start
        // Add the "admin" role to the user
        const response = await UserRoles.addRoleToUser(userId, "admin");

        if (response.status === "UNKNOWN_ROLE_ERROR") {
            // No such role exists
            return;
        }

        // Get the updated list of roles that the user is assigned
        let roles = (await UserRoles.getRolesForUser(userId)).roles;

        let currAccessTokenPayload = req.session!.getAccessTokenPayload();

        await req.session!.updateAccessTokenPayload(
            { ...currAccessTokenPayload, roles }
        );
        // highlight-end

        //....
    }
})
```
</TabItem>
<TabItem value="fastify">

```tsx
import Fastify from "fastify";
import { verifySession } from "supertokens-node/recipe/session/framework/fastify";
import { SessionRequest } from "supertokens-node/framework/fastify";
import UserRoles from "supertokens-node/recipe/userroles";

let fastify = Fastify();

fastify.post("/set-role", {
    preHandler: verifySession(),
}, async (req: SessionRequest, res) => {
    let userId = req.session!.getUserId();

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
        return;
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    let currAccessTokenPayload = req.session!.getAccessTokenPayload();

    await req.session!.updateAccessTokenPayload(
        { ...currAccessTokenPayload, roles }
    );
    // highlight-end

    //....
});
```

</TabItem>
<TabItem value="awsLambda">

```tsx
import { verifySession } from "supertokens-node/recipe/session/framework/awsLambda";
import { SessionEvent } from "supertokens-node/framework/awsLambda";
import UserRoles from "supertokens-node/recipe/userroles";

async function setRole(awsEvent: SessionEvent) {
    let userId = awsEvent.session!.getUserId();

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
        return;
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    let currAccessTokenPayload = awsEvent.session!.getAccessTokenPayload();

    await awsEvent.session!.updateAccessTokenPayload(
        { ...currAccessTokenPayload, roles }
    );
    // highlight-end

    //....
};

exports.handler = verifySession(setRole);
```

</TabItem>
<TabItem value="koa">

```tsx
import KoaRouter from "koa-router";
import { verifySession } from "supertokens-node/recipe/session/framework/koa";
import {SessionContext} from "supertokens-node/framework/koa";
import UserRoles from "supertokens-node/recipe/userroles";

let router = new KoaRouter();

router.post("/set-role", verifySession(), async (ctx: SessionContext, next) => {
    let userId = ctx.session!.getUserId();

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
        return;
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    let currAccessTokenPayload = ctx.session!.getAccessTokenPayload();

    await ctx.session!.updateAccessTokenPayload(
        {...currAccessTokenPayload, roles}
    );
    // highlight-end
    
    //....
});
```

</TabItem>
<TabItem value="loopback">

```tsx
import { inject, intercept } from "@loopback/core";
import { RestBindings, MiddlewareContext, post, response } from "@loopback/rest";
import { verifySession } from "supertokens-node/recipe/session/framework/loopback";
import Session from "supertokens-node/recipe/session";
import UserRoles from "supertokens-node/recipe/userroles";

class SetRole {
    constructor(@inject(RestBindings.Http.CONTEXT) private ctx: MiddlewareContext) { }
    @post("/set-role")
    @intercept(verifySession())
    @response(200)
    async handler() {
        let userId = ((this.ctx as any).session as Session.SessionContainer).getUserId();

        // highlight-start
        // Add the "admin" role to the user
        const response = await UserRoles.addRoleToUser(userId, "admin");

        if (response.status === "UNKNOWN_ROLE_ERROR") {
            // No such role exists
            return;
        }

        // Get the updated list of roles that the user is assigned
        let roles = (await UserRoles.getRolesForUser(userId)).roles;

        let currAccessTokenPayload = (this.ctx as any).session!.getAccessTokenPayload();

        await ((this.ctx as any).session as Session.SessionContainer).updateAccessTokenPayload(
            { ...currAccessTokenPayload, roles }
        );
        // highlight-end

        //....
    }
}
```

</TabItem>
<TabItem value="nextjs">

```tsx
import { superTokensNextWrapper } from 'supertokens-node/nextjs'
import { verifySession } from "supertokens-node/recipe/session/framework/express";
import { SessionRequest } from "supertokens-node/framework/express";
import UserRoles from "supertokens-node/recipe/userroles";

// highlight-start
export default async function setRole(req: SessionRequest, res: any) {
    await superTokensNextWrapper(
        async (next) => {
            await verifySession()(req, res, next);
        },
        req,
        res
    )

    let userId = req.session!.getUserId();

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
        return;
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    let currAccessTokenPayload = req.session!.getAccessTokenPayload();

    await req.session!.updateAccessTokenPayload(
        { ...currAccessTokenPayload, roles }
    );
    // highlight-end

    //....
}
```

</TabItem>
<TabItem value="nestjs">

```tsx
import { Controller, Post, UseGuards, Request, Response, Session } from "@nestjs/common";
import { SessionContainer } from "supertokens-node/recipe/session";
// @ts-ignore
import { AuthGuard } from './auth/auth.guard';
import UserRoles from "supertokens-node/recipe/userroles";

@Controller()
export class ExampleController {
  @Post('example')
  @UseGuards(AuthGuard)
  async postExample(@Session() session: SessionContainer): Promise<boolean> {
    // For more information about "AuthGuard" and the "Session" decorator please read our NestJS guide.
    let userId = session.getUserId(); 

    // highlight-start
    // Add the "admin" role to the user
    const response = await UserRoles.addRoleToUser(userId, "admin");

    if (response.status === "UNKNOWN_ROLE_ERROR") {
        // No such role exists
    }

    // Get the updated list of roles that the user is assigned
    let roles = (await UserRoles.getRolesForUser(userId)).roles;

    const currAccessTokenPayload = session.getAccessTokenPayload();
    
    await session.updateAccessTokenPayload(
        {...currAccessTokenPayload, roles}
    );

    // highlight-end
    //....
    return true;
  }
}
```
</TabItem>

</NodeJSFrameworkSubTabs>
</TabItem>
<TabItem value="go">
TODO

</TabItem>
<TabItem value="python">

<PythonFrameworkSubTabs>
<TabItem value="fastapi">

TODO

</TabItem>
<TabItem value="flask">

TODO

</TabItem>
<TabItem value="django">

TODO

</TabItem>
</PythonFrameworkSubTabs>

</TabItem>
</BackendSDKTabs>
