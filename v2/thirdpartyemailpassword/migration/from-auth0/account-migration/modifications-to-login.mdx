---
id: modifications-to-login
title: Modifications to login
hide_title: true
---
import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';


# Modifications to Login

In this section we will be modifying login to enable the migrating of users with EmailPassword or Social accounts from Auth0 to SuperTokens.

:::info
The following code is implemented for Nodejs, but, you can apply the same logic in your own tech stack.
:::

<Tabs
    groupId="migration-methods"  
    defaultValue="method-1"
    values={[
        {label: "EmailPassword Account Migration", value: 'method-1'},
        {label: 'Social Account Migration', value: 'method-2'},
]}>

<TabItem value="method-1">

## EmailPassword Account Migration


### Flow 

:::tip
If you have not stored your user's Auth0 userId in your database you can **ignore** the steps mentioned in **Box 5** and **Box 8** of the flow diagram.
:::

<img src="/img/thirdpartyemailpassword/ep-account-migration.png" />

### Implementation

We will be overriding SuperToken's login functions to enable account migration, if a user signs up, a new SuperTokens account will be created so no changes need to be made to the sign up functionality. 

#### Modifying the `signIn` function on the backend:

```jsx title="Nodejs"
ThirdPartyEmailPassword.init({
    override: {
        functions: (orignalImpl) => {
            return {
                ...orignalImpl,
                // EmailPassword Login function modification
                signIn: async function (input) {

                    // Box 2: check if the User exists in Auth0
                    if(await doesUserExistInAuth0(input.email)){

                        // Box 3: check if user exists in SuperTokens
                        let superTokensUsers = await this.getUsersByEmail({ email: input.email });
                        let emailPasswordUserExists = false;

                        for (let i = 0; i < superTokensUsers.length; i++) {
                            if (users[i].thirdParty === undefined) {
                                emailPasswordUserExists = true
                            }
                        }

                        let response;

                        // check that if a SuperTokens user exits, they are not an EmailPassword User
                        if( !emailPasswordUserExists ){
                            // EmailPassword User with the input credentials does not exist in SuperTokens

                            // Box 6: validate users credentials in Auth0
                            let auth0UserInfo = await validateAndGetUserInfoFromAuth0( input.email, input.passoword)

                            if ( auth0UserInfo === undefined ){
                                // Box 9: return WRONG_CREDENTIALS_ERROR
                                return {
                                     status: "WRONG_CREDENTIALS_ERROR"
                                }
                            }

                            // Box 7: call the signup function to create a new SuperTokens user.
                            response = await this.signUp(input)
                            // Box 8: map the Auth0 userId to the SuperTokens userId (Optional)
                            setUserIdMapping({ auth0UserId: auth0UserData.sub, supertokensUserId: response.user.id})                          

                        } else {
                            // Box 4: EmailPassword User with the input credentials exists in SuperTokens, so call the orignal signIn implementation
                            response = await orignalImpl.signIn(input)
                        }

                        // Box 5: Set the userId in the response to use the Auth0 userId (Optional)
                        response.user.id = auth0UserData.sub
                        return response

                    } else {
                        // Box 10: user does not exist in Auth0 call orignal signIn implementation
                        return orignalImpl.signIn(input)
                    }                    
                },
            }
        }
    },
})

```

### User Migration Scheme
After making the changes mentioned above you can now decide how you would like to migrate your users:

There are two methods of migrating user accounts:
- Using Auth0's APIs
- Using the exported user data and password hashes from Auth0

<Tabs
    groupId="ep-migration-methods"  
    defaultValue="migration-method-1"
    values={[
        {label: "Using Auth0's APIs", value: 'migration-method-1'},
        {label: 'Using the exported Auth0 user data and password hashes. ', value: 'migration-method-2'},
]}>

<TabItem value="migration-method-1">

#### Using Auth0's APIs

In this method we will be using Auth0's APIs to check if the user signing in is an Auth0 user.

##### Prerequisites
- This method assumes you have access to your Auth0 account and database for the complete duration of user migration.
- To enable email and password validation, you will need to add the database connection name to the `Default Directory` field in your Auth0 tenant settings.

For example:
- The default connection name for the database is `Username-Password-Authentication`, you can find your database connections under Authentication -> Database on your Auth0 dashboard.

<img src="/img/thirdpartyemailpassword/auth0-database.png" />

- Set your database connection name in your `Default Directory` field in your tennant settings.

<img src="/img/thirdpartyemailpassword/default-directory-settings.png" />

##### Implementation

Implementation for the `validateAndGetUserInfoFromAuth0` and `doesUserExistInAuth0` functions used in SuperTokens `signIn` function:

The functions below uses Auth0's Authentication and Management APIs to access user information and validate credentials. Please refer to their [documentation](https://auth0.com/docs/api) to get the complete spec for the APIs used below.

```jsx title="Nodejs"

let validateAndGetUserInfoFromAuth0 = async (email, password) => {

    try {
        // generate an user access token using the input credentials
        let access_token = (await axios({
            method: "post",
            // TODO: add your Auth0 domain 
            url: "https://YOUR_AUTH0_DOMAIN/oauth/token",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
            },
            data: {
                // TODO: add your Auth0 app's clientId
                client_id: "YOUR_CLIENT_ID",
                grant_type: "password",
                username: email,
                password: password,
            }
        })).data.access_token;

        // retive the users info using the access token if valid crendentials were passed
        // TODO: add your Auth0 domain 
        let userResponse = await axios.get("https://YOUR_AUTH0_DOMAIN/userInfo", {
            headers: { "authorization": `Bearer ${access_token}` },
        })
        return userResponse.data

    } catch (error) {
        // user does not exist in Auth0
        return undefined
    }
}

let doesUserExistInAuth0 = async (email) => {

    let access_token = (await axios({
        method: 'POST',
        // TODO: add your Auth0 domain
        url: "https://YOUR_DOMAIN/oauth/token",
        headers: { 'content-type': 'application/json' },
        data: {
            // TODO: add your Auth0 app's clientId
            client_id: "CLIENT_ID",
            // TODO: add your Auth0 app's clientSecret
            client_secret: "CLIENT_SECRET",
            // TODO: add your Auth0 domain
            audience: "https://YOUR_DOMAIN/api/v2/",
            grant_type: "client_credentials"
        }
    })).data.access_token

    let response = await axios({
            method: 'GET',
            // TODO: add your Auth0 domain
            url: "https://YOUR_DOMAIN/api/v2/users",
            params: { q: `identities.isSocial:false AND  email:${email}` },
            headers: { authorization: `Bearer ${access_token}` }
    })
    if(response.data[0] !== undefined){
        return true
    }
    return false
}


```

</TabItem>


<TabItem value="migration-method-2">

####  Using the exported Auth0 user data and password hashes. 

- By default Auth0 uses `bcrypt` to hash passwords with `$2a$` or `$2b$` identifiers and have 10 `saltRounds`.

##### Prerequisites
- This method assumes you have an Auth0 enterprise account so you can export your Auth0 user data and password hashes.
- You can refer to the following guides on how to export your [user data](https://auth0.com/docs/users/import-and-export-users/bulk-user-exports) and [password hashes](https://auth0.com/docs/support/manage-subscriptions/export-data).


##### Implementation

Implementation for the `validateAndGetUserInfoFromAuth0` and `doesUserExistInAuth0` functions used in SuperTokens `signIn` function:

```jsx
let bcrypt = require("bcryptjs")

// read exported Auth0 user info and password hashes
let auth0UsersDataString = fs.readFileSync(__dirname + auth0ExportedUsersDataFile)
let auth0UsersData = JSON.parse(auth0UsersDataString);

let validateAndGetUserInfoFromAuth0= async (email, password) => {

    // get auth0 user info
    let auth0UsersInfo = auth0UsersData.userData
    
    // get auth0 password hashes
    let auth0PasswordHashes = auth0UsersData.passwordHashes

    // check if input email has an associated user
    for (let i = 0; i < auth0UsersInfo.length; i++) {
        if ((!auth0UsersInfo[i].identities[0].isSocial) && auth0UsersInfo[i].email === email) {

            // get password hash from associated userid
            let usersPasswordHash = undefined
            for (let i = 0; i < auth0PasswordHashes.length; i++) {
                if (auth0PasswordHashes[i]._id.$oid === auth0UsersInfo[i].identities[0].user_id) {
                    usersPasswordHash = auth0PasswordHashes[i].passwordHash;
                    break;
                }
            }

            if(usersPasswordHash === undefined){
                return undefined
            }

            if(bcrypt.compareSync(password, passwordHash)){
                return auth0UsersInfo[i]
            } else {
                return undefined
            }
        }
    }
}

let doesUserExistInAuth0 = async (email) => {

    // get auth0 user info
    let auth0UsersInfo = auth0UsersData.userData

    // check if input email has an associated user
    for (let i = 0; i < auth0UsersInfo.length; i++) {
        if ((!auth0UsersInfo[i].identities[0].isSocial) && auth0UsersInfo[i].email === email) {
            return true
        }
    }
    return false
}

```

</TabItem>

</Tabs>
</TabItem>



<TabItem value="method-2">

## Social Account Migration

### Flow 

:::tip
If you have not stored your user's Auth0 userId in your database you can **ignore** the steps mentioned in **Box 5** and **Box 7** of the flow diagram.
:::


<img src="/img/thirdpartyemailpassword/tp-account-migration.png" />

### Implementation

We will be overriding SuperToken's login functions to enable account migration, if a user signs up, a new SuperTokens account will be created so no changes need to be made to the sign up functionality. 

#### Modifying the `signInUp` function on the backend:

```jsx title="Nodejs"
ThirdPartyEmailPassword.init({
    override: {
        functions: (orignalImpl) => {
            return {
                ...orignalImpl,
                // Social Login function modification
                signInUp: async function (input) {

                    // Box 2: check if a user with the input ThirdParty userId exists in Auth0
                    if (await doesUserExistInAuth0(input.user.thirdParty.userId)){
                        

                        let auth0SocialUserId = await getUsersAuth0UserIdFromThirdPartyId(input.user.thirdParty.userId)

                        // Box 3: call the Supertokens signInUp implementation
                        let response = await orignalImpl.signInUp(input)
                        
                        // Box 4: check if user existed in SuperTokens
                        if (response.createdNewUser){
                            // Box 5: map the Auth0 userId to the SuperTokens userId (Optional)
                            setUserIdMapping({ auth0UserId: auth0SocialUserId, supertokensUserId: response.user.id})
                            
                            // Box 6: Set the newly created flag value to false in the response
                            response.createdNewUser = false
                        }
                        
                        // Box 7: Set the userId in the response to use the Auth0 userId. (Optional)
                        response.user.id = auth0SocialUserId

                        return response

                    } else {
                        // Box 8: Auth0 user does not exist
                        return await orignalImpl.signInUp(input)
                    }
                }
            }
        }
    },
})

```
### User Migration Scheme
After making the changes mentioned above you can now decide how you would like to migrate your users:

There are two methods of migrating user accounts:
- Using Auth0's APIs
- Using the exported user data and password hashes from Auth0


<Tabs
    groupId="ep-migration-methods"  
    defaultValue="migration-method-1"
    values={[
        {label: "Using Auth0's APIs", value: 'migration-method-1'},
        {label: 'Using the exported Auth0 user data', value: 'migration-method-2'},
]}>

<TabItem value="migration-method-1">

#### Using Auth0's APIs

In this method we will be using Auth0's APIs to check if the user signing in is an Auth0 user.

##### Prerequisites
- This method assumes you have access to your Auth0 account and database for the complete duration of user migration.

##### Implementation

IImplementation for the `doesUserExistInAuth0` and `getUsersAuth0UserIdFromThirdPartyId` functions used in SuperTokens `signInUp` function:

The functions below uses Auth0's Management API to access user information. Please refer to their [documentation](https://auth0.com/docs/api) to get the complete spec for the APIs used below.

```jsx title="Nodejs"

// generate an access_token so you can use the Auth0 management API
let access_token = (await axios({
    method: 'POST',
    url: "https://YOUR_DOMAIN/oauth/token",
    headers: { 'content-type': 'application/json' },
    data: {
        client_id: "CLIENT_ID",
        client_secret: "CLIENT_SECRET",
        audience: "https://YOUR_DOMAIN/api/v2/",
        grant_type: "client_credentials"
    }
})).data.access_token


let doesUserExistInAuth0 = async (userId) => {
    
    let response = await axios({
        method: 'GET',
        url: "https://YOUR_DOMAIN/api/v2/users",
        params: { q: `identities.user_id:"${userId}"` },
        headers: { authorization: `Bearer ${access_token}` }
    })

    if(response.data.[0] !== undefined){
     return true;   
    }

    return false
}

let getUsersAuth0UserIdFromThirdPartyId = async (thirdPartyId) => {

    let response = await axios({
        method: 'GET',
        url: "https://YOUR_DOMAIN/api/v2/users",
        params: { q: `identities.user_id:"${userId}"` },
        headers: { authorization: `Bearer ${access_token}` }
    })

    return response.data[0].user_id;
}


```

</TabItem>


<TabItem value="migration-method-2">

####  Using the exported Auth0 user data. 


##### Prerequisites
- This method assumes you have an Auth0 enterprise account so you can export your Auth0 user data.

##### Implementation

Implementation for the `doesThirdPartyUserIdExistInAuth0`  function used in SuperTokens `signInUp` function:

```jsx
let bcrypt = require("bcryptjs")

// read exported Auth0 user info and password hashes
let auth0UsersDataString = fs.readFileSync(__dirname + auth0ExportedUsersDataFile)
let auth0UsersData = JSON.parse(auth0UsersDataString);

let doesUserExistInAuth0 = async (userId) => {

   // get auth0 user info
    let auth0UsersInfo = auth0UsersData.userData
    for (let i = 0; i < auth0UsersInfo.length; i++) {
         // check if input userId has an associated user which is social and userId matches 
        if ((auth0UsersInfo[i].identities[0].isSocial) && auth0UsersInfo[i].identities[0].user_id === userId) {
            
            return true
        }
    }
    return false
}

let getUsersAuth0UserIdFromThirdPartyId = async (thirdPartyId) => {
     let auth0UsersInfo = auth0UsersData.userData
    for (let i = 0; i < auth0UsersInfo.length; i++) {
         // check if input userId has an associated user which is social and userId matches 
        if ((auth0UsersInfo[i].identities[0].isSocial) && auth0UsersInfo[i].identities[0].user_id === userId) {
            
            return auth0UsersInfo[i].user_id
        }
    }
}

```

</TabItem>

</Tabs>

</TabItem>
</Tabs>

We can now move on to the next section discussing the `setUserIdMapping` function and how userId's should be mapped.