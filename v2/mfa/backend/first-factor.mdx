---
id: first-factor
title: "Setting up the first factor"
hide_title: true
---

import BackendSDKTabs from "/src/components/tabs/BackendSDKTabs";
import TabItem from '@theme/TabItem';
import NodeJSFrameworkSubTabsServerless from "/src/components/tabs/NodeJSFrameworkSubTabsServerless"
import GoFrameworkSubTabs from "/src/components/tabs/GoFrameworkSubTabs"
import PythonFrameworkSubTabs from "/src/components/tabs/PythonFrameworkSubTabs"
import BackendSDKCasing from "/src/components/BackendSDKCasing"
import AppInfoForm from "/src/components/appInfoForm"
import CoreInjector from "/src/components/coreInjector"

# Setting up the 1st factor

## 1) Initialisation

Start by following the recipe guide for the first factor. In this guide, we will take the example of [thirdpartyemailpassword recipe](https://supertokens.com/docs/thirdpartyemailpassword/introduction) as being the first factor.

After following the [backend quick setup section](https://supertokens.com/docs/thirdpartyemailpassword/quick-setup/backend) (or any of the framework specific integration guides), you should have all the auth APIs exposed by the SuperTokens middleware. The `supertokens.init` code on the server would look like this:

<AppInfoForm
    askForAppName
    askForAPIDomain
    askForWebsiteDomain
>

<CoreInjector>

<BackendSDKTabs>
<TabItem value="nodejs">

<NodeJSFrameworkSubTabsServerless>
<TabItem value="express">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "express",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/thirdpartyemailpassword/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init() // initializes session features
    ]
});
```
</TabItem>

<TabItem value="hapi">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "hapi",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init() // initializes session features
    ]
});
```
</TabItem>

<TabItem value="fastify">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "fastify",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init() // initializes session features
    ]
});
```
</TabItem>

<TabItem value="koa">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "koa",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init() // initializes session features
    ]
});
```
</TabItem>

<TabItem value="loopback">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "loopback",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init() // initializes session features
    ]
});
```
</TabItem>
<TabItem value="serverless">

:::important
Please refer the **Serverless Deployment** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
<TabItem value="nextjs">

:::important
Please refer the **NextJS** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
<TabItem value="nestjs">

:::important
Please refer the **NestJS** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
</NodeJSFrameworkSubTabsServerless>
</TabItem>
<TabItem value="go">

```go
import (
	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/thirdpartyemailpassword"
	"github.com/supertokens/supertokens-golang/recipe/thirdpartyemailpassword/tpepmodels"
	"github.com/supertokens/supertokens-golang/supertokens"
)

func main() {
    apiBasePath := "^{form_apiBasePath}"
    websiteBasePath := "^{form_websiteBasePath}"
	err := supertokens.Init(supertokens.TypeInput{
		Supertokens: &supertokens.ConnectionInfo{
            ^{coreInjector_connection_uri_comment}
            ConnectionURI: ^{coreInjector_uri}
            ^{coreInjector_api_key_commented}APIKey: ^{coreInjector_api_key},
		},
		AppInfo: supertokens.AppInfo{
            AppName: "^{form_appName}",
            APIDomain: "^{form_apiDomain}",
            WebsiteDomain: "^{form_websiteDomain}",
            APIBasePath: &apiBasePath,
            WebsiteBasePath: &websiteBasePath,
		},
		RecipeList: []supertokens.Recipe{
			thirdpartyemailpassword.Init(&tpepmodels.TypeInput{/*...*/}),
			session.Init(nil), // initializes session features
		},
	})

	if err != nil {
		panic(err.Error())
	}
}
```
</TabItem>
<TabItem value="python">
<PythonFrameworkSubTabs>
<TabItem value="fastapi">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='fastapi',
    recipe_list=[
	    session.init(), # initializes session features
        thirdpartyemailpassword.init(
           # ...
        )
    ],
    mode='asgi' # use wsgi if you are running using gunicorn
)
```

</TabItem>
<TabItem value="flask">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='flask',
    recipe_list=[
	    session.init(), # initializes session features
        thirdpartyemailpassword.init(
           # ...
        )
    ]
)
```

</TabItem>
<TabItem value="django">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='django',
    recipe_list=[
	    session.init(), # initializes session features
        thirdpartyemailpassword.init(
           # ...
        )
    ],
    mode='asgi' # use wsgi if you are running django server in sync mode
)
```

</TabItem>
</PythonFrameworkSubTabs>
</TabItem>
</BackendSDKTabs>
</CoreInjector>
</AppInfoForm>

:::important
You should have also added the SuperTokens `middleware` and `errorHandler` (depending on your framework) to your application. We are not showing it in the above code snippet for brevity, but it is explained in the ThirdPartyEmailPassword recipe guide. 
:::

## 2) Adding SecondFactorClaim

After sign up or sign in of the first factor, the existence of the session signifies the completion of the first factor, but we want to explicitly mark the second factor as incomplete. This can be done by overriding the `createNewSession` function in the `Session.init` config:

<BackendSDKTabs>
<TabItem value="nodejs">

```tsx
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import Passwordless from "supertokens-node/recipe/passwordless";
import { BooleanClaim } from "supertokens-node/recipe/session/claims";

// this could be moved to a separate file as well
export const SecondFactorClaim = new BooleanClaim({
    fetchValue: () => false,
    key: "2fa-completed",
});

Session.init({
    override: {
        functions: (originalImplementation) => {
            return {
                ...originalImplementation,
                /* This function is called after signing in or signing up via the first factor */
                createNewSession: async function (input) {
                    return originalImplementation.createNewSession({
                        ...input,
                        accessTokenPayload: {
                            ...input.accessTokenPayload,
                            ...SecondFactorClaim.build(input.userId, input.userContext),
                        },
                    });
                },
            };
        },
    },
})
```

</TabItem>
<TabItem value="go">

```go
import (
	"net/http"

	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/session/sessmodels"
	"github.com/supertokens/supertokens-golang/supertokens"
)
TODO
func main() {
	session.Init(&sessmodels.TypeInput{
		Override: &sessmodels.OverrideStruct{
			Functions: func(originalImplementation sessmodels.RecipeInterface) sessmodels.RecipeInterface {
				oCreateNewSession := *originalImplementation.CreateNewSession
				/* This function is called after signing in or signing up via the first factor */
				nCreateNewSession := func(res http.ResponseWriter, userID string, accessTokenPayload map[string]interface{}, sessionData map[string]interface{}, userContext supertokens.UserContext) (sessmodels.SessionContainer, error) {
					accessTokenPayload["is2faComplete"] = false
					return oCreateNewSession(res, userID, accessTokenPayload, sessionData, userContext)
				}
				*originalImplementation.CreateNewSession = nCreateNewSession
				return originalImplementation
			},
		},
	})
}
```

</TabItem>
<TabItem value="python">

```python
from supertokens_python.recipe import session
from supertokens_python.recipe.session.interfaces import RecipeInterface
from typing import Any, Dict, Union

TODO
# highlight-start
def override_session_functions(original_implementation: RecipeInterface):
    original_create_new_session = original_implementation.create_new_session

    async def create_new_session(
        request: Any,
        user_id: str,
        access_token_payload: Union[None, Dict[str, Any]],
        session_data: Union[None, Dict[str, Any]],
        user_context: Dict[str, Any],
    ):
        # This function is called after signing in or signing up via the first factor

        # Insert "is2faComplete" in access token payload
        if access_token_payload is None:
            access_token_payload = {}

        access_token_payload = {**access_token_payload, "is2faComplete": False}
        return await original_create_new_session(
            request, user_id, access_token_payload, session_data, user_context
        )

    original_implementation.create_new_session = create_new_session
    return original_implementation
# highlight-end

session.init(
    # highlight-next-line
    override=session.InputOverrideConfig(functions=override_session_functions)
)

```

</TabItem>
</BackendSDKTabs>

We add `SecondFactorClaim` into the access token payload. This will be set to false by default (see `fetchValue` in the claim definition). This will indicate to the API routes and to the frontend that only the first factor has been completed. You can change the key to some other name as well.

:::important
`SecondFactorClaim` has to have matching definitions on both the frontend and the backend.
:::