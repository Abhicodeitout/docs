---
id: backend-setup
title: 1. Backend Setup
hide_title: true
---

<!-- COPY DOCS -->
<!-- ./session/graphql-integration/backend-setup.mdx -->

# Backend Setup

## a) Complete Quick Setup

Complete both steps from the quick setup guide for SuperTokens:
- [Frontend Quick Setup](../quick-setup/Frontend)
- [Backend Quick Setup](../quick-setup/backend)

<!-- COPY SECTION -->
<!-- ./session/graphql-integration/backend-setup.mdx -->
<!-- 1 -->

## b) Install GraphQL dependencies on your backend

:::info
We use Apollo server in this example, SuperTokens can be used with other GraphQL libraries as well.
:::

```bash
npm install @apollo/server graphql
```

## c) Setup GraphQL

### Create your schema 

In this example we will create the following:
- A query to verify that a session exists
- A mutation to login
- A mutation of logout

```tsx
const typeDefs = `
type Query {
    verify: String,
}

type Mutation {
    login(email: String, password: String): String
    logout: String,
}
`;
```

### Create resolvers

We use the `Session` recipe from `supertokens-node` to create, revoke and verify user sessions.

```tsx
import Session from "supertokens-node/recipe/session";

const resolvers = {
    Query: {
        verify: async (_: any, __: any, contextValue: any) => {
            let session = await Session.getSession(contextValue.req, contextValue.res);
            return "Session exists";
        }
    },
    Mutation: {
        login: async (_: any, args: any, contextValue: any) => {
            try {
                let {email, password} = args;

                // TODO: Validate credentials
                let userId = "userId";
                await Session.createNewSession(contextValue.req, contextValue.res, userId);
                return "Session Created";
            } catch (e) {
                throw e;
            }
        },
        logout: async (_: any, args: any, contextValue: any) => {
            let session = await Session.getSession(contextValue.req, contextValue.res);
            await session.revokeSession();
            return "Session revoked";
        }
    },
}
```

:::note
In the code above we read `req` and `res` from `contextValue`, refer to the next step to see how this is being added to the graphql context
:::

Refer to the [official Apollo guide](https://www.apollographql.com/docs/apollo-server/schema/schema) to know more about creating queries, mutations and resolvers.

## d) Add the GraphQL middleware to your server

:::info
When using Apollo server, you must use `expressMiddleware` in order to use SuperTokens because `startStandaloneServer` does not let you configure custom CORS settings
:::

Next we create an instance of `ApolloServer` which is added to our server using `expressMiddleware` provided by the Apollo package.

We need to create a plugin so that we can handle errors thrown by the SuperTokens SDK in a specific way. This is because GraphQL by default returns HTTP status code `200` for errors which is incompatible with the SuperTokens frontend SDKs. In order to work around this we use the `errorHandler` provided by the SuperTokens SDK to handle errors if they are thrown by the SuperTokens SDK, all other errors will be handled by Apollo in the normal way.

```tsx
import { ApolloServer } from "@apollo/server";
import express from "express";
import { expressMiddleware } from "@apollo/server/express4";
import {errorHandler} from "supertokens-node/framework/express/index.js";

let app = express();

const typeDefs = '' // Refer to previous step
const resolvers = {} // Refer to previous step

const server = new ApolloServer({
    typeDefs,
    resolvers,
    plugins: [
        {
            requestDidStart: async () => {
                return {
                    didEncounterErrors: async (requestContext) => {
                        const {req, res} = requestContext.contextValue as any;
                        for (let i = 0; i < requestContext.errors.length; i++) {
                            let error = requestContext.errors[i].originalError;
                            await new Promise(async (resolve) => {
                                // This will handle any session or other SuperTokens related errors
                                await errorHandler()(error, req, res, (err) => {
                                    resolve(undefined);
                                });
                            });
                        }
                    },
                };
            }
        }
    ],
})

server.start().then(() => {
    // Use expressMiddleware only after server.start has resolved
    app.use(express.json(), expressMiddleware(server, {
        context: async ({req, res}) => {
            return {
              // We add this so that we can access sessions in the resolvers
                req,
                res,
            };
        },
    }))

    app.listen(3001, () => {
        console.log("Server started");
    })
})
```

:::important
Note that we add the request and response objects to the GraphQL context object when using `expressMiddleware`. These are then used in the resolvers in the previous steps along with the Session recipe for supertokens-node.
:::

Refer to [this page](../common-customizations/sessions/session-verification-in-api/verify-session#the-session-object) to know more about the session object

<!-- END COPY SECTION -->
